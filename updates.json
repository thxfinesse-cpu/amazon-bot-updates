{
  "manifest.json": "{\n  \"manifest_version\": 3,\n  \"name\": \"Amazon Stealth Pro (Smart Navigator)\",\n  \"version\": \"17.0\",\n  \"permissions\": [\"storage\", \"scripting\"],\n  \"host_permissions\": [\"https://api.openai.com/*\", \"<all_urls>\"],\n  \"content_scripts\": [\n    {\n      \"matches\": [\"<all_urls>\"],\n      \"js\": [\"content.js\"],\n      \"run_at\": \"document_idle\"\n    }\n  ],\n  \"action\": { \"default_popup\": \"popup.html\" }\n}",

  "popup.html": "<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { width: 260px; padding: 15px; font-family: -apple-system, sans-serif; }\n    .header { font-size: 14px; font-weight: 700; color: #333; margin-bottom: 10px; text-align: center; }\n    .counter-box { background: #f3f4f6; border-radius: 6px; padding: 8px; text-align: center; margin-bottom: 10px; }\n    .count { font-size: 20px; font-weight: 800; color: #10a37f; }\n    input { width: 100%; padding: 8px; margin-bottom: 8px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }\n    button { width: 100%; padding: 12px; margin-bottom: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 12px; transition: 0.2s; }\n    \n    /* Toggle Button Styles */\n    .btn-off { background: #e5e7eb; color: #374151; border: 1px solid #d1d5db; }\n    .btn-on { background: #10a37f; color: white; box-shadow: 0 2px 5px rgba(16, 163, 127, 0.3); }\n    .btn-auto-on { background: #f59e0b; color: white; box-shadow: 0 2px 5px rgba(245, 158, 11, 0.3); }\n    \n    #analyzeBtn { background: #8b5cf6; color: white; padding: 8px; font-weight: 600; } \n    #saveBtn { background: #2563eb; color: white; padding: 8px; }\n    \n    .status { font-size: 10px; color: #666; text-align: center; margin-top: 5px; }\n    .section-label { font-size: 10px; text-transform: uppercase; color: #999; font-weight: bold; margin-top: 10px; margin-bottom: 4px; }\n  </style>\n</head>\n<body>\n  <div class=\"header\">AMAZON STEALTH PRO</div>\n  <div class=\"counter-box\">\n    Posts Today: <span id=\"countDisplay\" class=\"count\">0</span>\n  </div>\n\n  <div class=\"section-label\">Normal Assist Mode</div>\n  <button id=\"normalToggle\" class=\"btn-off\">ðŸ”´ START NORMAL ASSIST</button>\n\n  <div class=\"section-label\">Fully Automated Browsing</div>\n  <button id=\"autoToggle\" class=\"btn-off\">ðŸ”´ START AUTO-BROWSE</button>\n\n  <div style=\"height:1px; background:#eee; margin: 10px 0;\"></div>\n  \n  <button id=\"analyzeBtn\">ðŸ”® LEARN VIBE</button>\n  <input type=\"password\" id=\"apiKey\" placeholder=\"sk-...\">\n  <button id=\"saveBtn\">Save API Key</button>\n  \n  <div class=\"status\" id=\"vibeStatus\">Brain: 0 Examples</div>\n  <script src=\"popup.js\"></script>\n</body>\n</html>",

  "popup.js": "browser.storage.local.get(['apiKey', 'postCount', 'learnedExamples', 'normalMode', 'autoMode']).then(data => {\n  if (data.apiKey) document.getElementById('apiKey').value = data.apiKey;\n  document.getElementById('countDisplay').innerText = data.postCount || 0;\n  updateBrainStatus(data.learnedExamples);\n  updateButtons(data.normalMode, data.autoMode);\n});\n\nfunction updateBrainStatus(examples) {\n  const el = document.getElementById('vibeStatus');\n  const count = examples ? examples.length : 0;\n  el.innerText = `Brain: ${count} Examples Learned ðŸ§ `;\n}\n\nfunction updateButtons(normal, auto) {\n  const normalBtn = document.getElementById('normalToggle');\n  const autoBtn = document.getElementById('autoToggle');\n\n  if (normal) {\n    normalBtn.className = 'btn-on';\n    normalBtn.innerText = 'ðŸŸ¢ STOP NORMAL ASSIST';\n  } else {\n    normalBtn.className = 'btn-off';\n    normalBtn.innerText = 'ðŸ”´ START NORMAL ASSIST';\n  }\n\n  if (auto) {\n    autoBtn.className = 'btn-auto-on';\n    autoBtn.innerText = 'ðŸŸ¢ STOP AUTO-BROWSE';\n  } else {\n    autoBtn.className = 'btn-off';\n    autoBtn.innerText = 'ðŸ”´ START AUTO-BROWSE';\n  }\n}\n\ndocument.getElementById('normalToggle').addEventListener('click', async () => {\n  const data = await browser.storage.local.get('normalMode');\n  const newState = !data.normalMode;\n  await browser.storage.local.set({ normalMode: newState });\n  updateButtons(newState, false);\n  // Send signal to content\n  let [tab] = await browser.tabs.query({ active: true, currentWindow: true });\n  browser.tabs.sendMessage(tab.id, { action: \"toggle_normal\", state: newState });\n});\n\ndocument.getElementById('autoToggle').addEventListener('click', async () => {\n  const data = await browser.storage.local.get('autoMode');\n  const newState = !data.autoMode;\n  await browser.storage.local.set({ autoMode: newState });\n  updateButtons(false, newState);\n  // Send signal to content to kickstart automation\n  let [tab] = await browser.tabs.query({ active: true, currentWindow: true });\n  browser.tabs.sendMessage(tab.id, { action: \"toggle_auto\", state: newState });\n});\n\ndocument.getElementById('saveBtn').addEventListener('click', () => {\n  const key = document.getElementById('apiKey').value;\n  browser.storage.local.set({ apiKey: key }).then(() => alert(\"Key Saved.\"));\n});\n\ndocument.getElementById('analyzeBtn').addEventListener('click', async () => {\n  let [tab] = await browser.tabs.query({ active: true, currentWindow: true });\n  browser.tabs.sendMessage(tab.id, { action: \"analyze_vibe\" });\n  window.close();\n});",

  "content.js": "const SIX_HOURS = 6 * 60 * 60 * 1000;\nlet isKilled = false;\nlet uiShadowRoot = null;\nconst isTargetSite = window.location.hostname.includes(\"hackforums.net\");\n\n// --- MAIN LOOP & STATE MANAGEMENT ---\nasync function masterLoop() {\n  if (!isTargetSite) return;\n  \n  // 1. Identify User (For Anti-Double-Post)\n  // Look for \"Welcome back, [Name]\"\n  const welcome = document.querySelector('.welcome strong a');\n  if (welcome) {\n    const username = welcome.innerText.trim();\n    await browser.storage.local.set({ myUsername: username });\n  }\n\n  const data = await browser.storage.local.get(['normalMode', 'autoMode', 'justPosted', 'myUsername']);\n\n  // --- AUTO MODE LOGIC ---\n  if (data.autoMode) {\n    createShadowUI(\"AUTO-BROWSE ACTIVE â©\");\n    \n    // STATE 1: Just Posted -> Go Home to find new section\n    if (data.justPosted) {\n      console.log(\"Auto: Post confirmed. Returning Home...\");\n      await browser.storage.local.set({ justPosted: false });\n      window.location.href = \"https://hackforums.net/index.php\";\n      return;\n    }\n\n    // STATE 2: On Homepage -> Find Popular Section\n    if (window.location.href.includes(\"index.php\")) {\n      setStatus(\"Scanning for Popular Sections...\");\n      setTimeout(() => navigateToPopularSection(), 2000);\n    }\n    \n    // STATE 3: On Section List -> Find Fresh Thread\n    else if (window.location.href.includes(\"forumdisplay.php\")) {\n      setStatus(\"Looking for fresh threads...\");\n      setTimeout(() => navigateToFreshThread(data.myUsername), 2000);\n    }\n\n    // STATE 4: On Thread -> Generate Reply\n    else if (window.location.href.includes(\"showthread.php\")) {\n      // Safety Check: Did I post last?\n      if (isLastPostByMe(data.myUsername)) {\n        setStatus(\"Skipping: I posted last.\");\n        setTimeout(() => window.history.back(), 2000); // Go back to list\n      } else {\n        setStatus(\"Generating Reply...\");\n        // Only run generation if box is empty\n        const box = hasReplyBox();\n        if (box && !box.value) generateResponse(data.apiKey, null, null);\n      }\n    }\n  }\n  \n  // --- NORMAL MODE LOGIC ---\n  else if (data.normalMode) {\n    createShadowUI(\"NORMAL ASSIST ACTIVE ðŸŸ¢\");\n    // Only generate if explicitly asked or just monitor? \n    // User asked: \"Find a thread I like -> It types reply\". \n    // So we just run the generator if we see a box.\n    if (window.location.href.includes(\"showthread.php\")) {\n       const box = hasReplyBox();\n       if (box && !box.value && !uiShadowRoot.getElementById('sb-summary').innerText) {\n         generateResponse(data.apiKey, null, null);\n       }\n    }\n  }\n  \n  // --- IDLE ---\n  else {\n     if(document.getElementById('amz-partner-host')) document.getElementById('amz-partner-host').remove();\n  }\n}\n\n// --- NAVIGATION FUNCTIONS ---\nfunction navigateToPopularSection() {\n  // Find sections with high viewers\n  const rows = document.querySelectorAll('tr');\n  const candidates = [];\n  \n  rows.forEach(row => {\n    const text = row.innerText;\n    const viewMatch = text.match(/(\\d+)[\\s\\xa0]?(Viewing|Users|Active)/i) || text.match(/Viewing:\\s*(\\d+)/i);\n    if (viewMatch) {\n      const val = parseInt(viewMatch[1].replace(/,/g, ''));\n      const link = row.querySelector('strong a, a strong') || row.querySelector('a');\n      // Filter: Ignore \"Marketplace\" if we want general chatter, or keep it. Let's keep all.\n      if (val > 10 && link) candidates.push(link);\n    }\n  });\n\n  if (candidates.length > 0) {\n    const choice = candidates[Math.floor(Math.random() * candidates.length)];\n    choice.style.border = \"2px solid blue\";\n    window.location.href = choice.href;\n  } else {\n    // Fallback: Just pick a random forum link\n    const links = document.querySelectorAll('a[href*=\"forumdisplay.php\"]');\n    window.location.href = links[Math.floor(Math.random() * links.length)].href;\n  }\n}\n\nfunction navigateToFreshThread(myUsername) {\n  const rows = Array.from(document.querySelectorAll('tr.inline_row'));\n  const validThreads = [];\n  const SEVEN_DAYS = 7 * 24 * 60 * 60;\n  const now = Math.floor(Date.now() / 1000);\n\n  rows.forEach(row => {\n    // 1. Time Check\n    const timeSpan = row.querySelector('.smart-time');\n    const timestamp = timeSpan ? parseInt(timeSpan.dataset.timestamp) : 0;\n    const isFresh = (timestamp > 0 && (now - timestamp) < SEVEN_DAYS);\n\n    // 2. Sticky Check (Optional, usually we want normal threads)\n    const isSticky = row.innerText.includes(\"Sticky\");\n\n    // 3. Last Poster Check\n    let lastPoster = \"\";\n    const lastPostLink = row.querySelector('.lastpost a[href*=\"profile\"]');\n    if (lastPostLink) lastPoster = lastPostLink.innerText.trim();\n    const isMe = (myUsername && lastPoster === myUsername);\n\n    if (isFresh && !isSticky && !isMe) {\n      const link = row.querySelector('span[id^=\"tid_\"] a');\n      if (link) validThreads.push(link);\n    }\n  });\n\n  if (validThreads.length > 0) {\n    const choice = validThreads[Math.floor(Math.random() * validThreads.length)];\n    choice.style.backgroundColor = \"yellow\";\n    setTimeout(() => window.location.href = choice.href, 1000);\n  } else {\n    // No fresh threads? Go Home.\n    window.location.href = \"https://hackforums.net/index.php\";\n  }\n}\n\nfunction isLastPostByMe(myUsername) {\n  if (!myUsername) return false;\n  // In thread view, we check the last post container\n  // But easiest is to check the LAST .post_author element\n  const authors = document.querySelectorAll('.post_author a span');\n  if (authors.length > 0) {\n    const lastAuthor = authors[authors.length - 1].innerText.trim();\n    return lastAuthor === myUsername;\n  }\n  return false;\n}\n\n// --- CORE FUNCTIONS ---\nfunction hasReplyBox() {\n  return document.getElementById('message') || document.querySelector('textarea, [contenteditable=\"true\"]');\n}\n\nfunction setStatus(msg) {\n  if (uiShadowRoot && uiShadowRoot.getElementById('sb-status')) {\n    uiShadowRoot.getElementById('sb-status').innerText = msg;\n  }\n}\n\nfunction createShadowUI(modeText) {\n  if (document.getElementById('amz-partner-host')) return;\n  const host = document.createElement('div'); host.id = 'amz-partner-host';\n  host.style.position = 'absolute'; host.style.top = '0'; host.style.left = '0'; host.style.zIndex = '2147483647';\n  document.body.appendChild(host);\n  uiShadowRoot = host.attachShadow({ mode: 'open' });\n\n  const container = document.createElement('div');\n  const color = modeText.includes('AUTO') ? '#f59e0b' : '#10a37f';\n  container.style = `position: fixed; top: 20px; right: 20px; width: 260px; background: #fff; border-left: 5px solid ${color}; border-radius: 5px; padding: 15px; font-family: sans-serif; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 9999;`;\n  container.innerHTML = `\n    <div style=\"font-size:10px; color:${color}; font-weight:bold; margin-bottom:5px;\">${modeText}</div>\n    <div id=\"sb-status\" style=\"font-weight:bold; color:#333; font-size:12px; margin-bottom:8px;\">Initializing...</div>\n    <div id=\"sb-summary\" style=\"font-size:11px; color:#666; margin-bottom:8px;\"></div>\n  `;\n  uiShadowRoot.appendChild(container);\n}\n\nasync function generateResponse(apiKey) {\n  const data = await browser.storage.local.get(['customPersona', 'learnedExamples']);\n  const status = uiShadowRoot.getElementById('sb-status');\n  const summaryBox = uiShadowRoot.getElementById('sb-summary');\n\n  const examples = data.learnedExamples || [];\n  const cheatSheet = examples.slice(-5).map(t => `\"${t}\"`).join(\"\\n\");\n\n  let systemPrompt = `\n    You are a forum user. Account Age: 2023.\n    RULES:\n    1. NEVER say \"back in the day\".\n    2. IF List/Stats: Short OBSERVATION only.\n    3. IF Lounge: Casual statement. 1 sentence.\n  `;\n  \n  if (data.customPersona) systemPrompt = data.customPersona;\n  if (cheatSheet) systemPrompt += `\\n\\nMIMIC THIS USER STYLE:\\n${cheatSheet}`;\n\n  const threadTitle = document.title;\n  const threadBody = document.body.innerText.substring(0, 1500);\n\n  try {\n    const response = await fetch('https://api.openai.com/v1/chat/completions', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },\n      body: JSON.stringify({\n        model: \"gpt-4o-mini\",\n        messages: [{\n          role: \"system\",\n          content: systemPrompt + \"\\nOutput: SUMMARY: [text] || REPLY: [text]\"\n        }, {\n          role: \"user\",\n          content: `Thread: ${threadTitle}\\nContext: ${threadBody}`\n        }]\n      })\n    });\n    const result = await response.json();\n    const [summary, reply] = result.choices[0].message.content.split('||');\n\n    summaryBox.innerHTML = `<b>Topic:</b> ${summary.replace('SUMMARY:', '').trim()}`;\n    status.innerText = \"Reply Ready.\";\n    status.style.color = \"green\";\n\n    const cleanReply = reply.replace('REPLY:', '').trim();\n    const box = hasReplyBox();\n    if (box) {\n      box.tagName === 'TEXTAREA' ? box.value = cleanReply : box.innerText = cleanReply;\n      box.dispatchEvent(new Event('input', { bubbles: true }));\n      box.scrollIntoView({ behavior: \"smooth\", block: \"center\" });\n    }\n  } catch (err) { status.innerText = \"Error: \" + err.message; }\n}\n\n// --- LISTENERS ---\n// 1. Detect Post Click\ndocument.addEventListener('click', (e) => {\n  const target = e.target;\n  if (target.matches('button, input[type=\"submit\"], a.button') && /post|reply|submit/i.test(target.innerText || target.value)) {\n    browser.storage.local.set({ justPosted: true });\n    // Learning Logic...\n    const box = hasReplyBox();\n    const finalContent = box.tagName === 'TEXTAREA' ? box.value : box.innerText;\n    if (finalContent.length > 5) {\n       browser.storage.local.get('learnedExamples').then(d => {\n         const ex = d.learnedExamples || [];\n         if(!ex.includes(finalContent)) ex.push(finalContent);\n         browser.storage.local.set({ learnedExamples: ex });\n       });\n    }\n  }\n});\n\n// 2. Detect Toggles from Popup\nbrowser.runtime.onMessage.addListener((req) => {\n  if(req.action === 'toggle_normal' || req.action === 'toggle_auto') masterLoop();\n  if(req.action === 'analyze_vibe') performVibeCheck(); // Re-use old vibe check\n});\n\n// 3. Start Loop\nsetInterval(masterLoop, 2000);"
}
