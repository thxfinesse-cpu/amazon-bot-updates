{
  "manifest.json": "{\n  \"manifest_version\": 3,\n  \"name\": \"Amazon Stealth Pro (Site Mapper)\",\n  \"version\": \"13.0\",\n  \"permissions\": [\"storage\", \"scripting\"],\n  \"host_permissions\": [\"https://api.openai.com/*\", \"<all_urls>\"],\n  \"content_scripts\": [\n    {\n      \"matches\": [\"<all_urls>\"],\n      \"js\": [\"content.js\"],\n      \"run_at\": \"document_idle\"\n    }\n  ],\n  \"action\": { \"default_popup\": \"popup.html\" }\n}",

  "popup.html": "<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { width: 250px; padding: 15px; font-family: -apple-system, sans-serif; }\n    .header { font-size: 14px; font-weight: 700; color: #333; margin-bottom: 10px; text-align: center; }\n    .counter-box { background: #f3f4f6; border-radius: 6px; padding: 8px; text-align: center; margin-bottom: 10px; }\n    .count { font-size: 20px; font-weight: 800; color: #10a37f; }\n    input { width: 100%; padding: 8px; margin-bottom: 8px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }\n    button { width: 100%; padding: 10px; margin-bottom: 6px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px; }\n    #recBtn { background: #ef4444; color: white; } /* Red */\n    #analyzeBtn { background: #8b5cf6; color: white; }\n    #heatBtn { background: #f59e0b; color: white; }\n    #saveBtn { background: #2563eb; color: white; }\n    #resetBtn { background: white; border: 1px solid #ddd; color: #666; font-size: 10px; }\n    .status { font-size: 10px; color: #666; text-align: center; margin-top: 5px; }\n  </style>\n</head>\n<body>\n  <div class=\"header\">AMAZON STEALTH PRO</div>\n  <div class=\"counter-box\">\n    Posts Today: <span id=\"countDisplay\" class=\"count\">0</span>\n  </div>\n  \n  <button id=\"recBtn\">üî¥ START HTML RECORDING</button>\n  <button id=\"heatBtn\">üî• SCAN HEATMAP</button>\n  <button id=\"analyzeBtn\">üîÆ ANALYZE VIBE</button>\n  <div style=\"height:1px; background:#eee; margin: 10px 0;\"></div>\n  \n  <input type=\"password\" id=\"apiKey\" placeholder=\"sk-...\">\n  <button id=\"saveBtn\">Save API Key</button>\n  <button id=\"resetBtn\">Clear Learned Brain üß†</button>\n  \n  <div class=\"status\" id=\"vibeStatus\">Brain: 0 Examples Learned</div>\n  <script src=\"popup.js\"></script>\n</body>\n</html>",

  "popup.js": "browser.storage.local.get(['apiKey', 'postCount', 'customPersona', 'learnedExamples', 'isRecording']).then(data => {\n  if (data.apiKey) document.getElementById('apiKey').value = data.apiKey;\n  document.getElementById('countDisplay').innerText = data.postCount || 0;\n  updateBrainStatus(data.learnedExamples);\n  updateRecButton(data.isRecording);\n});\n\nfunction updateBrainStatus(examples) {\n  const el = document.getElementById('vibeStatus');\n  const count = examples ? examples.length : 0;\n  el.innerText = `Brain: ${count} Examples Learned üß†`;\n  if (count > 0) el.style.color = \"#10a37f\";\n}\n\nfunction updateRecButton(isRec) {\n  const btn = document.getElementById('recBtn');\n  if (isRec) {\n    btn.innerText = \"üíæ STOP & DOWNLOAD MAP\";\n    btn.style.background = \"#10a37f\";\n    btn.classList.add('recording');\n  } else {\n    btn.innerText = \"üî¥ START HTML RECORDING\";\n    btn.style.background = \"#ef4444\";\n    btn.classList.remove('recording');\n  }\n}\n\ndocument.getElementById('saveBtn').addEventListener('click', () => {\n  const key = document.getElementById('apiKey').value;\n  browser.storage.local.set({ apiKey: key }).then(() => alert(\"Key Saved.\"));\n});\n\ndocument.getElementById('recBtn').addEventListener('click', async () => {\n  const data = await browser.storage.local.get(['isRecording', 'htmlLog']);\n  \n  if (data.isRecording) {\n    // STOP AND DOWNLOAD\n    const logs = data.htmlLog || [];\n    const blob = new Blob([JSON.stringify(logs, null, 2)], {type: \"application/json\"});\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = \"forum_map.json\";\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    \n    await browser.storage.local.set({ isRecording: false });\n    updateRecButton(false);\n  } else {\n    // START\n    await browser.storage.local.set({ isRecording: true, htmlLog: [] });\n    updateRecButton(true);\n    alert(\"üî¥ RECORDING STARTED\\n\\nNavigate to different sections (Home, Lounge, Business). The bot will capture the layout of each page you visit.\\n\\nClick this button again to STOP and Download.\");\n  }\n});\n\ndocument.getElementById('heatBtn').addEventListener('click', async () => {\n  let [tab] = await browser.tabs.query({ active: true, currentWindow: true });\n  browser.tabs.sendMessage(tab.id, { action: \"scan_heatmap\" });\n  window.close();\n});\n\ndocument.getElementById('analyzeBtn').addEventListener('click', async () => {\n  let [tab] = await browser.tabs.query({ active: true, currentWindow: true });\n  browser.tabs.sendMessage(tab.id, { action: \"analyze_vibe\" });\n  window.close();\n});\n\ndocument.getElementById('resetBtn').addEventListener('click', () => {\n  if(confirm(\"Delete all learned reply examples?\")) {\n    browser.storage.local.remove(['customPersona', 'learnedExamples']).then(() => {\n      updateBrainStatus([]);\n      alert(\"Brain wiped clean.\");\n    });\n  }\n});",

  "content.js": "const SIX_HOURS = 6 * 60 * 60 * 1000;\nlet isKilled = false;\nlet uiShadowRoot = null;\nconst isTargetSite = window.location.hostname.includes(\"hackforums.net\");\n\n// --- SITE MAPPER RECORDER ---\nasync function checkRecording() {\n  if (!isTargetSite) return;\n  const data = await browser.storage.local.get(['isRecording', 'htmlLog']);\n  if (data.isRecording) {\n    // Capture Page HTML\n    const clone = document.documentElement.cloneNode(true);\n    // Strip heavy tags to save space\n    const junk = clone.querySelectorAll('script, style, svg, img, iframe');\n    junk.forEach(el => el.remove());\n    \n    const cleanHTML = clone.outerHTML.substring(0, 150000); // Limit size per page\n    const logs = data.htmlLog || [];\n    \n    // Avoid duplicate URLs\n    if (!logs.some(l => l.url === window.location.href)) {\n      logs.push({\n        url: window.location.href,\n        title: document.title,\n        html: cleanHTML\n      });\n      await browser.storage.local.set({ htmlLog: logs });\n      \n      // Visual Indicator\n      const badge = document.createElement('div');\n      badge.innerText = \"üî¥ RECORDING PAGE STRUCTURE\";\n      badge.style = \"position:fixed; bottom:10px; right:10px; background:red; color:white; padding:5px 10px; font-size:10px; z-index:999999; border-radius:4px;\";\n      document.body.appendChild(badge);\n    }\n  }\n}\ncheckRecording();\n\n// --- MESSAGE LISTENER ---\nbrowser.runtime.onMessage.addListener((request) => {\n  if (!isTargetSite) return alert(\"Bot Sleep Mode Active (Not on HackForums)\");\n  if (request.action === \"analyze_vibe\") performVibeCheck();\n  if (request.action === \"scan_heatmap\") performHeatmapScan();\n});\n\n// --- HEATMAP FUNCTION ---\nfunction performHeatmapScan() {\n  const rows = document.querySelectorAll('tr');\n  let maxVal = 0;\n  let foundCount = 0;\n\n  rows.forEach(row => {\n    const text = row.innerText;\n    const viewMatch = text.match(/\\(?(\\d+)[\\s\\xa0]?(Viewing|Users|Active)\\)?/i);\n    if (viewMatch) {\n       const val = parseInt(viewMatch[1]);\n       if (val > 0) {\n         row.dataset.heatVal = val;\n         if (val > maxVal) maxVal = val;\n         foundCount++;\n       }\n    }\n  });\n\n  if (foundCount === 0) return alert(\"No 'Viewing' stats found. Try refreshing the page.\");\n\n  rows.forEach(row => {\n    const val = parseInt(row.dataset.heatVal || 0);\n    if (val > (maxVal * 0.5)) {\n       row.style.boxShadow = \"inset 5px 0 0 red\";\n       row.style.backgroundColor = \"rgba(255, 0, 0, 0.05)\";\n    }\n  });\n  alert(`Scan Complete. Found ${foundCount} active sections. Top traffic: ${maxVal} viewers.`);\n}\n\n// --- VIBE CHECK ---\nasync function performVibeCheck() {\n  const data = await browser.storage.local.get('apiKey');\n  if (!data.apiKey) return alert(\"Please save API Key first.\");\n\n  const pageText = document.body.innerText.substring(0, 3000);\n  const learningNotification = document.createElement('div');\n  learningNotification.style = \"position:fixed; top:10px; right:10px; background:#8b5cf6; color:white; padding:15px; border-radius:8px; z-index:999999; font-family:sans-serif; font-weight:bold; box-shadow:0 5px 15px rgba(0,0,0,0.2);\";\n  learningNotification.innerText = \"üîÆ Analyzing Section Vibe...\";\n  document.body.appendChild(learningNotification);\n\n  try {\n    const response = await fetch('https://api.openai.com/v1/chat/completions', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${data.apiKey}` },\n      body: JSON.stringify({\n        model: \"gpt-4o-mini\",\n        messages: [{\n          role: \"system\",\n          content: \"Analyze forum text. Output System Prompt mimicking tone. If Lounge/General: Chill, simple, 2023 account. If Business: Expert.\"\n        }, {\n          role: \"user\",\n          content: `Context: ${pageText}`\n        }]\n      })\n    });\n    \n    const result = await response.json();\n    const newPersona = result.choices[0].message.content;\n    \n    await browser.storage.local.set({ customPersona: newPersona });\n    learningNotification.style.background = \"#10a37f\";\n    learningNotification.innerText = \"‚úÖ Vibe Learned!\";\n    setTimeout(() => learningNotification.remove(), 2000);\n  } catch (err) {\n    alert(\"Analysis Failed: \" + err.message);\n    learningNotification.remove();\n  }\n}\n\nasync function initStealthBot() {\n  if (!isTargetSite) return;\n  const data = await browser.storage.local.get(['apiKey', 'repliedThreads', 'customPersona']);\n  if (!data.apiKey) return;\n\n  let modeText = \"Amazon Expert Mode\";\n  if (data.customPersona) modeText = \"Custom Vibe Active\";\n  else if (document.title.match(/Lounge|General|Off-Topic/i)) modeText = \"Auto-Lounge Mode üõãÔ∏è\";\n  else if (document.title.match(/Intro|Welcome/i)) modeText = \"Intro Mode üëã\";\n\n  createShadowUI(modeText);\n\n  const threadId = window.location.href.split(/[?#]/)[0];\n  const history = data.repliedThreads || {};\n  if (history[threadId] && (Date.now() - history[threadId] < SIX_HOURS)) {\n    uiShadowRoot.getElementById('sb-status').innerText = \"Skipping (Replied recently)\";\n    return;\n  }\n\n  let attempts = 0;\n  const finder = setInterval(() => {\n    attempts++;\n    const box = hasReplyBox();\n    if (box) {\n      clearInterval(finder);\n      uiShadowRoot.getElementById('sb-status').innerText = \"Target Found. Generating...\";\n      generateResponse(data.apiKey, threadId, data.customPersona);\n    } else if (attempts > 5) {\n      clearInterval(finder);\n      uiShadowRoot.getElementById('sb-status').innerText = \"No Editor Found.\";\n    }\n  }, 1000);\n}\n\nfunction hasReplyBox() {\n  return document.querySelector('textarea, [contenteditable=\"true\"], .cke_editable, .fr-element');\n}\n\nfunction createShadowUI(modeText) {\n  if (document.getElementById('amz-partner-host')) return;\n  const host = document.createElement('div'); host.id = 'amz-partner-host';\n  host.style.position = 'absolute'; host.style.top = '0'; host.style.left = '0'; host.style.zIndex = '2147483647';\n  document.body.appendChild(host);\n  uiShadowRoot = host.attachShadow({ mode: 'open' });\n\n  const container = document.createElement('div');\n  container.style = \"position: fixed; top: 20px; right: 20px; width: 260px; background: #fff; border-left: 5px solid \" + (modeText.includes('Lounge') ? '#f59e0b' : '#10a37f') + \"; border-radius: 5px; padding: 15px; font-family: sans-serif; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 9999;\";\n  container.innerHTML = `\n    <div style=\"font-size:10px; color:\" + (modeText.includes('Lounge') ? '#f59e0b' : '#10a37f') + \"; font-weight:bold; margin-bottom:5px;\">${modeText}</div>\n    <div id=\"sb-status\" style=\"font-weight:bold; color:#333; font-size:12px; margin-bottom:8px;\">Scanning...</div>\n    <div id=\"sb-summary\" style=\"font-size:11px; color:#666; margin-bottom:8px;\"></div>\n    <div style=\"font-size:9px; color:#999; border-top:1px solid #eee; padding-top:5px;\">Alt+9: Regen | Alt+Shift+K: Kill</div>\n  `;\n  uiShadowRoot.appendChild(container);\n}\n\nasync function generateResponse(apiKey, threadId, customPersona) {\n  if (isKilled) return;\n  const status = uiShadowRoot.getElementById('sb-status');\n  const summaryBox = uiShadowRoot.getElementById('sb-summary');\n  \n  const mem = await browser.storage.local.get('learnedExamples');\n  const examples = mem.learnedExamples || [];\n  const cheatSheet = examples.slice(-5).map(t => `\"${t}\"`).join(\"\\n\");\n\n  let systemPrompt = `\n    You are a forum user. Account Age: 2023.\n    RULES:\n    1. NEVER say \"back in the day\".\n    2. IF List/Stats: Short observation only.\n    3. IF Intro: Welcome warmly.\n    4. IF Lounge: Casual statement. 1 sentence.\n    5. IF Business: Professional Amazon expert.\n  `;\n\n  if (customPersona) systemPrompt = customPersona + \"\\nREMEMBER: 2023 user rules apply.\";\n  else if (document.title.match(/Lounge|General|Off-Topic/i)) systemPrompt = \"Casual Lounge user. 2023 account. Short, chill statement. 1 sentence.\";\n  else if (document.title.match(/Intro|Welcome/i)) systemPrompt = \"Friendly user welcoming a newbie. Say 'Welcome to the forum, good luck!'.\";\n\n  if (cheatSheet) systemPrompt += `\\n\\nMIMIC THIS USER STYLE:\\n${cheatSheet}`;\n\n  const threadTitle = document.title;\n  const threadBody = document.body.innerText.substring(0, 1500);\n\n  try {\n    const response = await fetch('https://api.openai.com/v1/chat/completions', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },\n      body: JSON.stringify({\n        model: \"gpt-4o-mini\",\n        messages: [{\n          role: \"system\",\n          content: systemPrompt + \"\\nIMPORTANT: Output format: SUMMARY: [text] || REPLY: [text]\"\n        }, {\n          role: \"user\",\n          content: `Thread Title: ${threadTitle}\\nContext: ${threadBody}`\n        }]\n      })\n    });\n    const result = await response.json();\n    const [summary, reply] = result.choices[0].message.content.split('||');\n\n    summaryBox.innerHTML = `<b>Topic:</b> ${summary.replace('SUMMARY:', '').trim()}`;\n    status.innerText = \"Reply Ready.\";\n    status.style.color = \"green\";\n\n    const cleanReply = reply.replace('REPLY:', '').trim();\n    const box = hasReplyBox();\n    if (box) {\n      box.tagName === 'TEXTAREA' ? box.value = cleanReply : box.innerText = cleanReply;\n      box.dispatchEvent(new Event('input', { bubbles: true }));\n      box.scrollIntoView({ behavior: \"smooth\", block: \"center\" });\n    }\n  } catch (err) { status.innerText = \"Error: \" + err.message; }\n}\n\ndocument.addEventListener('click', (e) => {\n  const target = e.target;\n  if (target.matches('button, input[type=\"submit\"], a.button') && /post|reply|submit/i.test(target.innerText || target.value)) {\n    const threadId = window.location.href.split(/[?#]/)[0];\n    browser.storage.local.get(['repliedThreads', 'learnedExamples', 'postCount']).then(d => {\n      const updated = d.repliedThreads || {};\n      updated[threadId] = Date.now();\n      const box = hasReplyBox();\n      const finalContent = box.tagName === 'TEXTAREA' ? box.value : box.innerText;\n      const learned = d.learnedExamples || [];\n      if (finalContent && finalContent.length > 5 && !learned.includes(finalContent)) {\n        learned.push(finalContent);\n      }\n      browser.storage.local.set({ repliedThreads: updated, learnedExamples: learned, postCount: (d.postCount || 0) + 1 });\n    });\n  }\n});\n\ndocument.addEventListener('keydown', (e) => {\n  if (e.altKey && e.shiftKey && e.code === 'KeyK') { document.getElementById('amz-partner-host').remove(); isKilled = true; }\n  if (e.altKey && e.key === '9') location.reload();\n});\n\ninitStealthBot();"
}
