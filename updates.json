{
  "manifest.json": "{\n  \"manifest_version\": 3,\n  \"name\": \"Amazon Partner Bot - Fixed\",\n  \"version\": \"7.0\",\n  \"permissions\": [\"storage\", \"scripting\"],\n  \"host_permissions\": [\"https://api.openai.com/*\", \"<all_urls>\"],\n  \"content_scripts\": [\n    {\n      \"matches\": [\"<all_urls>\"],\n      \"js\": [\"content.js\"],\n      \"run_at\": \"document_idle\"\n    }\n  ],\n  \"action\": { \"default_popup\": \"popup.html\" }\n}",
  
  "popup.html": "<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { width: 220px; padding: 15px; font-family: sans-serif; }\n    .counter { text-align: center; font-size: 24px; font-weight: bold; color: #10a37f; margin-bottom: 10px; }\n    input { width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box; }\n    button { width: 100%; padding: 10px; margin-bottom: 5px; cursor: pointer; }\n    #saveBtn { background: #2563eb; color: white; border: none; }\n    #forceBtn { background: #10a37f; color: white; border: none; font-weight: bold; }\n  </style>\n</head>\n<body>\n  <div class=\"counter\" id=\"countDisplay\">0</div>\n  <div style=\"text-align:center; font-size:10px; color:#666; margin-bottom:10px;\">POSTS TODAY</div>\n  <input type=\"password\" id=\"apiKey\" placeholder=\"sk-...\">\n  <button id=\"saveBtn\">Save API Key</button>\n  <button id=\"forceBtn\">FORCE RUN ON PAGE</button>\n  <script src=\"popup.js\"></script>\n</body>\n</html>",
  
  "popup.js": "browser.storage.local.get(['apiKey', 'postCount']).then(data => {\n  if (data.apiKey) document.getElementById('apiKey').value = data.apiKey;\n  document.getElementById('countDisplay').innerText = data.postCount || 0;\n});\n\ndocument.getElementById('saveBtn').addEventListener('click', () => {\n  const key = document.getElementById('apiKey').value;\n  browser.storage.local.set({ apiKey: key }).then(() => alert(\"Key Saved. Refresh your forum page.\"));\n});\n\ndocument.getElementById('forceBtn').addEventListener('click', async () => {\n  let [tab] = await browser.tabs.query({ active: true, currentWindow: true });\n  browser.scripting.executeScript({\n    target: { tabId: tab.id },\n    files: ['content.js']\n  });\n  window.close();\n});",
  
  "content.js": "const SIX_HOURS = 6 * 60 * 60 * 1000;\nlet isKilled = false;\nlet uiShadowRoot = null;\n\nasync function initStealthBot() {\n  const data = await browser.storage.local.get(['apiKey', 'repliedThreads', 'botEnabled']);\n  if (!data.apiKey || data.botEnabled === false) return;\n\n  createShadowUI();\n  \n  const status = uiShadowRoot.getElementById('sb-status');\n  status.innerText = \"Scanning for thread...\";\n\n  const threadId = window.location.href.split(/[?#]/)[0];\n  const history = data.repliedThreads || {};\n  if (history[threadId] && (Date.now() - history[threadId] < SIX_HOURS)) {\n    status.innerText = \"Skipping: Already replied recently.\";\n    status.style.color = \"orange\";\n    return;\n  }\n\n  let attempts = 0;\n  const finder = setInterval(() => {\n    attempts++;\n    const box = hasReplyBox();\n    if (box) {\n      clearInterval(finder);\n      status.innerText = \"Editor found. Generating...\";\n      generateResponse(data.apiKey, threadId);\n    } else if (attempts > 5) {\n      clearInterval(finder);\n      status.innerText = \"No text box found. (Click to Retry)\";\n      status.style.cursor = \"pointer\";\n      status.onclick = () => location.reload();\n    }\n  }, 1000);\n}\n\nfunction hasReplyBox() {\n  return document.querySelector('textarea, [contenteditable=\"true\"], .cke_editable, .fr-element');\n}\n\nfunction createShadowUI() {\n  if (document.getElementById('amz-partner-host')) return;\n\n  const host = document.createElement('div');\n  host.id = 'amz-partner-host';\n  host.style.position = 'absolute'; host.style.top = '0'; host.style.left = '0'; host.style.zIndex = '2147483647';\n  document.body.appendChild(host);\n\n  uiShadowRoot = host.attachShadow({ mode: 'open' });\n\n  const style = document.createElement('style');\n  style.textContent = `\n    .box { position: fixed; top: 20px; right: 20px; width: 280px; background: #fff; border-left: 5px solid #10a37f; border-radius: 5px; padding: 15px; font-family: sans-serif; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 9999; }\n    .status { font-weight: bold; color: #333; font-size: 12px; margin-bottom: 8px; }\n    .summary { font-size: 11px; color: #666; margin-bottom: 8px; line-height: 1.4; }\n    .footer { font-size: 9px; color: #999; display: flex; justify-content: space-between; border-top: 1px solid #eee; padding-top: 5px; }\n  `;\n  \n  const container = document.createElement('div');\n  container.className = 'box';\n  container.innerHTML = `\n    <div id=\"sb-status\" class=\"status\">Initializing...</div>\n    <div id=\"sb-summary\" class=\"summary\"></div>\n    <div class=\"footer\">\n      <span>Alt+9: Regen</span>\n      <span>Alt+Shift+K: KILL</span>\n    </div>\n  `;\n\n  uiShadowRoot.appendChild(style);\n  uiShadowRoot.appendChild(container);\n}\n\nasync function generateResponse(apiKey, threadId) {\n  if (isKilled) return;\n  const status = uiShadowRoot.getElementById('sb-status');\n  const summaryBox = uiShadowRoot.getElementById('sb-summary');\n\n  const threadTitle = document.title;\n  const threadBody = document.querySelector('body')?.innerText.substring(0, 1500) || \"\";\n\n  try {\n    const response = await fetch('https://api.openai.com/v1/chat/completions', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },\n      body: JSON.stringify({\n        model: \"gpt-4o-mini\",\n        messages: [{\n          role: \"system\",\n          content: \"You are an Amazon FBA expert looking for partners. 1. Summarize thread (1 sentence). 2. Write a 2-sentence reply. Format: SUMMARY: [text] || REPLY: [text]\"\n        }, {\n          role: \"user\",\n          content: `Thread Title: ${threadTitle}\\nContext: ${threadBody}`\n        }]\n      })\n    });\n\n    const result = await response.json();\n    const [summary, reply] = result.choices[0].message.content.split('||');\n\n    summaryBox.innerHTML = `<b>Topic:</b> ${summary.replace('SUMMARY:', '').trim()}`;\n    status.innerText = \"Reply Ready. (Check Editor)\";\n    status.style.color = \"green\";\n\n    const cleanReply = reply.replace('REPLY:', '').trim();\n    const box = hasReplyBox();\n    if (box) {\n      box.tagName === 'TEXTAREA' ? box.value = cleanReply : box.innerText = cleanReply;\n      box.dispatchEvent(new Event('input', { bubbles: true }));\n      \n      browser.storage.local.get('postCount').then(d => {\n        browser.storage.local.set({ postCount: (d.postCount || 0) + 1 });\n      });\n    }\n  } catch (err) { status.innerText = \"Error: \" + err.message; }\n}\n\ndocument.addEventListener('keydown', (e) => {\n  if (e.altKey && e.shiftKey && e.code === 'KeyK') {\n    document.getElementById('amz-partner-host').remove();\n    isKilled = true;\n  }\n  if (e.altKey && e.key === '9') location.reload();\n});\n\ninitStealthBot();"
}
