{
  "manifest.json": "{\n  \"manifest_version\": 3,\n  \"name\": \"Amazon Stealth Pro + Lounge Mode\",\n  \"version\": \"8.5\",\n  \"permissions\": [\"storage\", \"scripting\"],\n  \"host_permissions\": [\"https://api.openai.com/*\", \"<all_urls>\"],\n  \"content_scripts\": [\n    {\n      \"matches\": [\"<all_urls>\"],\n      \"js\": [\"content.js\"],\n      \"run_at\": \"document_idle\"\n    }\n  ],\n  \"action\": { \"default_popup\": \"popup.html\" }\n}",

  "popup.html": "<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { width: 240px; padding: 15px; font-family: -apple-system, sans-serif; }\n    .header { font-size: 14px; font-weight: 700; color: #333; margin-bottom: 10px; text-align: center; }\n    .counter-box { background: #f3f4f6; border-radius: 6px; padding: 8px; text-align: center; margin-bottom: 10px; }\n    .count { font-size: 20px; font-weight: 800; color: #10a37f; }\n    input { width: 100%; padding: 8px; margin-bottom: 8px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }\n    button { width: 100%; padding: 10px; margin-bottom: 6px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px; }\n    #analyzeBtn { background: #8b5cf6; color: white; } /* Purple */\n    #analyzeBtn:hover { background: #7c3aed; }\n    #saveBtn { background: #2563eb; color: white; }\n    #resetBtn { background: white; border: 1px solid #ddd; color: #666; font-size: 10px; }\n    .status { font-size: 10px; color: #666; text-align: center; margin-top: 5px; }\n  </style>\n</head>\n<body>\n  <div class=\"header\">AMAZON STEALTH PRO</div>\n  <div class=\"counter-box\">\n    Posts Today: <span id=\"countDisplay\" class=\"count\">0</span>\n  </div>\n  \n  <button id=\"analyzeBtn\">üîÆ LEARN THIS SECTION'S VIBE</button>\n  <div style=\"height:1px; background:#eee; margin: 10px 0;\"></div>\n  \n  <input type=\"password\" id=\"apiKey\" placeholder=\"sk-...\">\n  <button id=\"saveBtn\">Save API Key</button>\n  <button id=\"resetBtn\">Reset Custom Vibe</button>\n  \n  <div class=\"status\" id=\"vibeStatus\">Vibe: Default</div>\n  <script src=\"popup.js\"></script>\n</body>\n</html>",

  "popup.js": "browser.storage.local.get(['apiKey', 'postCount', 'customPersona']).then(data => {\n  if (data.apiKey) document.getElementById('apiKey').value = data.apiKey;\n  document.getElementById('countDisplay').innerText = data.postCount || 0;\n  updateVibeStatus(data.customPersona);\n});\n\nfunction updateVibeStatus(persona) {\n  const el = document.getElementById('vibeStatus');\n  if (persona) {\n    el.innerText = \"Vibe: CUSTOM LEARNED ‚úÖ\";\n    el.style.color = \"#8b5cf6\";\n    el.style.fontWeight = \"bold\";\n  } else {\n    el.innerText = \"Vibe: Auto-Detect Mode\";\n    el.style.color = \"#666\";\n  }\n}\n\ndocument.getElementById('saveBtn').addEventListener('click', () => {\n  const key = document.getElementById('apiKey').value;\n  browser.storage.local.set({ apiKey: key }).then(() => alert(\"Key Saved.\"));\n});\n\ndocument.getElementById('analyzeBtn').addEventListener('click', async () => {\n  let [tab] = await browser.tabs.query({ active: true, currentWindow: true });\n  browser.tabs.sendMessage(tab.id, { action: \"analyze_vibe\" });\n  window.close();\n});\n\ndocument.getElementById('resetBtn').addEventListener('click', () => {\n  browser.storage.local.remove('customPersona').then(() => {\n    updateVibeStatus(null);\n    alert(\"Reset to Auto-Detect Mode.\");\n  });\n});",

  "content.js": "const SIX_HOURS = 6 * 60 * 60 * 1000;\nlet isKilled = false;\nlet uiShadowRoot = null;\n\n// --- MESSAGE LISTENER ---\nbrowser.runtime.onMessage.addListener((request) => {\n  if (request.action === \"analyze_vibe\") performVibeCheck();\n});\n\nasync function performVibeCheck() {\n  const data = await browser.storage.local.get('apiKey');\n  if (!data.apiKey) return alert(\"Please save API Key first.\");\n\n  const pageText = document.body.innerText.substring(0, 3000);\n  const learningNotification = document.createElement('div');\n  learningNotification.style = \"position:fixed; top:10px; right:10px; background:#8b5cf6; color:white; padding:15px; border-radius:8px; z-index:999999; font-family:sans-serif; font-weight:bold; box-shadow:0 5px 15px rgba(0,0,0,0.2);\";\n  learningNotification.innerText = \"üîÆ Analyzing Section Vibe... Please wait.\";\n  document.body.appendChild(learningNotification);\n\n  try {\n    const response = await fetch('https://api.openai.com/v1/chat/completions', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${data.apiKey}` },\n      body: JSON.stringify({\n        model: \"gpt-4o-mini\",\n        messages: [{\n          role: \"system\",\n          content: \"You are a social linguist. Analyze the forum text. Identify tone (casual, formal, aggressive) and topic.\\n\\nIMPORTANT: If the text is from a 'Lounge', 'General', or 'Off-topic' section, the persona MUST be a normal, relatable person discussing daily life/news. Do NOT mention business/Amazon.\\n\\nIf the text is business/tech, the persona should be an expert.\\n\\nOutput ONLY the System Prompt instructions.\"\n        }, {\n          role: \"user\",\n          content: `Forum Context: ${pageText}`\n        }]\n      })\n    });\n    \n    const result = await response.json();\n    const newPersona = result.choices[0].message.content;\n    \n    await browser.storage.local.set({ customPersona: newPersona });\n    learningNotification.style.background = \"#10a37f\";\n    learningNotification.innerText = \"‚úÖ Vibe Learned! Bot updated.\";\n    setTimeout(() => learningNotification.remove(), 3000);\n    \n  } catch (err) {\n    alert(\"Analysis Failed: \" + err.message);\n    learningNotification.remove();\n  }\n}\n\nasync function initStealthBot() {\n  const data = await browser.storage.local.get(['apiKey', 'repliedThreads', 'customPersona']);\n  if (!data.apiKey) return;\n\n  // Determine Display Mode\n  let modeText = \"Amazon Expert Mode\";\n  if (data.customPersona) modeText = \"Custom Vibe Active\";\n  else if (document.title.match(/Lounge|General|Off-Topic/i)) modeText = \"Auto-Lounge Mode üõãÔ∏è\";\n\n  createShadowUI(modeText);\n\n  const threadId = window.location.href.split(/[?#]/)[0];\n  const history = data.repliedThreads || {};\n  if (history[threadId] && (Date.now() - history[threadId] < SIX_HOURS)) {\n    uiShadowRoot.getElementById('sb-status').innerText = \"Skipping (Replied recently)\";\n    return;\n  }\n\n  let attempts = 0;\n  const finder = setInterval(() => {\n    attempts++;\n    const box = hasReplyBox();\n    if (box) {\n      clearInterval(finder);\n      uiShadowRoot.getElementById('sb-status').innerText = \"Target Found. Generating...\";\n      generateResponse(data.apiKey, threadId, data.customPersona);\n    } else if (attempts > 5) {\n      clearInterval(finder);\n      uiShadowRoot.getElementById('sb-status').innerText = \"No Editor Found.\";\n    }\n  }, 1000);\n}\n\nfunction hasReplyBox() {\n  return document.querySelector('textarea, [contenteditable=\"true\"], .cke_editable, .fr-element');\n}\n\nfunction createShadowUI(modeText) {\n  if (document.getElementById('amz-partner-host')) return;\n  const host = document.createElement('div'); host.id = 'amz-partner-host';\n  host.style.position = 'absolute'; host.style.top = '0'; host.style.left = '0'; host.style.zIndex = '2147483647';\n  document.body.appendChild(host);\n  uiShadowRoot = host.attachShadow({ mode: 'open' });\n\n  const container = document.createElement('div');\n  container.style = \"position: fixed; top: 20px; right: 20px; width: 260px; background: #fff; border-left: 5px solid \" + (modeText.includes('Lounge') ? '#f59e0b' : '#10a37f') + \"; border-radius: 5px; padding: 15px; font-family: sans-serif; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 9999;\";\n  container.innerHTML = `\n    <div style=\"font-size:10px; color:\" + (modeText.includes('Lounge') ? '#f59e0b' : '#10a37f') + \"; font-weight:bold; margin-bottom:5px;\">${modeText}</div>\n    <div id=\"sb-status\" style=\"font-weight:bold; color:#333; font-size:12px; margin-bottom:8px;\">Scanning...</div>\n    <div id=\"sb-summary\" style=\"font-size:11px; color:#666; margin-bottom:8px;\"></div>\n    <div style=\"font-size:9px; color:#999; border-top:1px solid #eee; padding-top:5px;\">Alt+9: Regen | Alt+Shift+K: Kill</div>\n  `;\n  uiShadowRoot.appendChild(container);\n}\n\nasync function generateResponse(apiKey, threadId, customPersona) {\n  if (isKilled) return;\n  const status = uiShadowRoot.getElementById('sb-status');\n  const summaryBox = uiShadowRoot.getElementById('sb-summary');\n  \n  // LOGIC: Custom > Auto-Lounge > Default Amazon\n  let systemPrompt = customPersona;\n  if (!systemPrompt) {\n    if (document.title.match(/Lounge|General|Off-Topic/i)) {\n       systemPrompt = \"You are a casual, friendly forum user hanging out in the Lounge. Discuss the topic normally. Do NOT mention business, Amazon, or selling. Be relatable and chill. Short reply (1-2 sentences).\";\n    } else {\n       systemPrompt = \"You are an expert Amazon FBA seller. Summarize thread (1 sentence). Write 2-sentence reply mentioning profitability/partners. Format: SUMMARY: [text] || REPLY: [text]\";\n    }\n  }\n  \n  const threadTitle = document.title;\n  const threadBody = document.body.innerText.substring(0, 1500);\n\n  try {\n    const response = await fetch('https://api.openai.com/v1/chat/completions', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },\n      body: JSON.stringify({\n        model: \"gpt-4o-mini\",\n        messages: [{\n          role: \"system\",\n          content: systemPrompt + \"\\nIMPORTANT: Output format must be: SUMMARY: [text] || REPLY: [text]\"\n        }, {\n          role: \"user\",\n          content: `Thread Title: ${threadTitle}\\nContext: ${threadBody}`\n        }]\n      })\n    });\n    const result = await response.json();\n    const [summary, reply] = result.choices[0].message.content.split('||');\n\n    summaryBox.innerHTML = `<b>Topic:</b> ${summary.replace('SUMMARY:', '').trim()}`;\n    status.innerText = \"Reply Ready.\";\n    status.style.color = \"green\";\n\n    const cleanReply = reply.replace('REPLY:', '').trim();\n    const box = hasReplyBox();\n    if (box) {\n      box.tagName === 'TEXTAREA' ? box.value = cleanReply : box.innerText = cleanReply;\n      box.dispatchEvent(new Event('input', { bubbles: true }));\n      browser.storage.local.get('postCount').then(d => browser.storage.local.set({ postCount: (d.postCount || 0) + 1 }));\n    }\n  } catch (err) { status.innerText = \"Error: \" + err.message; }\n}\n\ndocument.addEventListener('keydown', (e) => {\n  if (e.altKey && e.shiftKey && e.code === 'KeyK') { document.getElementById('amz-partner-host').remove(); isKilled = true; }\n  if (e.altKey && e.key === '9') location.reload();\n});\n\ninitStealthBot();"
}
